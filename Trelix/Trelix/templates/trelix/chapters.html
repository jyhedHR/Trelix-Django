{% extends "trelix/base.html" %}
{% load static %}
{% block title %} {{ course.title }} {% endblock %}

{% block content %}
{% include 'trelix/header.html' %}

<section class="course-lession bg-shade sec-padding overflow-hidden">
  <div class="container-fluid px-0">

    <!-- BOUTON SUMMARY AU CENTRE HAUT -->
    <div class="text-center my-4">
      <button id="generate-summary" class="btn btn-warning btn-lg shadow-sm px-4">
        <i class="bi bi-card-text me-2"></i> Generate Course Summary
      </button>
    </div>

    <div class="row">
      <!-- Sidebar Chapitres -->
      <div class="col-lg-4">
        <aside class="sidebar position-relative lession-sidebar px-4">
          <h1 class="display-4 mb-4">{{ course.title }}</h1>
          <div class="lesson-container list-group" id="chapter-list">
            {% for chapter in chapters %}
            <button type="button" class="list-group-item list-group-item-action {% if forloop.first %}active{% endif %}"
                    data-id="{{ chapter.id }}"
                    data-index="{{ forloop.counter0 }}"
                    data-title="{{ chapter.title|escapejs }}"
                    data-description="{{ chapter.description|escapejs }}"
                    data-video="{% if chapter.video %}{{ chapter.video.url }}{% endif %}">
              {{ forloop.counter }}. {{ chapter.title }}
            </button>
            {% endfor %}
          </div>
        </aside>
      </div>

      <!-- Contenu du chapitre -->
      <div class="col-lg-8">
        <div class="lesstion-wrap bg-white shadow-sm rounded p-4">

          <!-- Video -->
          <div class="lession-video mb-4" id="chapter-video" style="transition: opacity 0.3s;">
            {% if selected_chapter and selected_chapter.video %}
            <video controls width="100%" id="video-player" class="rounded shadow-sm">
              <source src="{{ selected_chapter.video.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
            {% else %}
            <p id="no-video-text" class="text-center text-muted py-5 border rounded">
              No video available for this chapter.
            </p>
            {% endif %}
          </div>

          <!-- Contenu -->
          <div class="lession-content" style="transition: opacity 0.3s;">
            <h3 class="display-5 mb-3" id="chapter-title">
              {% if selected_chapter %}
                Chapter 1: {{ selected_chapter.title }}
              {% else %}
                {{ course.title }}
              {% endif %}
            </h3>
            <p id="chapter-description" class="text-muted">
              {% if selected_chapter %}
                {{ selected_chapter.description }}
              {% else %}
                No content available.
              {% endif %}
            </p>
          </div>

          <!-- Conteneur du bouton Quiz -->
          <div class="text-center mt-4" id="quiz-button-container">
            <!-- Le bouton sera injecté via JS -->
          </div>

          <!-- Modal du quiz -->
          <div id="quizModal" class="modal fade" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content shadow-lg rounded-4 border-0">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title" id="quizModalLabel">Chapter Quiz</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="quiz-form">
                  <div class="modal-body p-4" id="quiz-content">
                    <div class="text-center text-muted">
                      <div class="spinner-border text-primary" role="status"></div>
                      <p class="mt-3">Generating quiz...</p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Submit Quiz</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Modal du résumé -->
          <div id="summaryModal" class="modal fade" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content shadow-lg rounded-4 border-0">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title" id="summaryModalLabel">Course Summary</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="summary-content">
                  <div class="text-center text-muted">
                    <div class="spinner-border text-warning" role="status"></div>
                    <p class="mt-3">Generating summary...</p>
                  </div>
                </div>
                <div class="modal-footer">
                  <a href="#" id="download-summary-pdf" class="btn btn-primary" target="_blank">
    <i class="bi bi-download me-2"></i> Download PDF
  </a>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation Next / Previous -->
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-primary" id="prev-chapter">Previous</button>
            <button type="button" class="btn btn-outline-primary" id="next-chapter">Next</button>
          </div>

        </div>
      </div>

    </div>
  </div>
</section>

{% include 'trelix/footer.html' %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  const buttons = Array.from(document.querySelectorAll('#chapter-list .list-group-item'));
  const titleEl = document.getElementById('chapter-title');
  const descEl = document.getElementById('chapter-description');
  const videoContainer = document.getElementById('chapter-video');
  const quizButtonContainer = document.getElementById('quiz-button-container');
  const quizContent = document.getElementById('quiz-content');
  const quizForm = document.getElementById('quiz-form');
  let currentIndex = 0;

  const userScores = {{ user_scores_json|safe }}; // dictionnaire {chapter_id: score}

  function scrollToActiveChapter(btn) {
    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function showChapter(index) {
    const btn = buttons[index];
    if (!btn) return;

    buttons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentIndex = index;
    localStorage.setItem('currentChapterIndex', currentIndex);
    scrollToActiveChapter(btn);

    const chapterId = btn.dataset.id;
    const newTitle = btn.dataset.title;
    const newDesc = btn.dataset.description;
    const newVideo = btn.dataset.video;

    titleEl.style.opacity = 0;
    descEl.style.opacity = 0;
    videoContainer.style.opacity = 0;

    setTimeout(() => {
      titleEl.textContent = `Chapter ${index + 1}: ${newTitle}`;
      descEl.textContent = newDesc;

      videoContainer.innerHTML = '';
      if (newVideo) {
        const videoEl = document.createElement('video');
        videoEl.setAttribute('controls', '');
        videoEl.setAttribute('width', '100%');
        videoEl.classList.add('rounded', 'shadow-sm');
        const sourceEl = document.createElement('source');
        sourceEl.src = newVideo;
        sourceEl.type = 'video/mp4';
        videoEl.appendChild(sourceEl);
        videoContainer.appendChild(videoEl);
      } else {
        videoContainer.innerHTML = '<p id="no-video-text" class="text-center text-muted py-5 border rounded">No video available for this chapter.</p>';
      }

      titleEl.style.opacity = 1;
      descEl.style.opacity = 1;
      videoContainer.style.opacity = 1;

      updateQuizButton(chapterId);
    }, 200);
  }

  document.getElementById('prev-chapter').addEventListener('click', () => {
    showChapter(Math.max(0, currentIndex - 1));
  });
  document.getElementById('next-chapter').addEventListener('click', () => {
    showChapter(Math.min(buttons.length - 1, currentIndex + 1));
  });
  buttons.forEach((btn, i) => btn.addEventListener('click', () => showChapter(i)));

  const savedIndex = localStorage.getItem('currentChapterIndex');
  if (savedIndex !== null && savedIndex < buttons.length) {
    showChapter(parseInt(savedIndex));
  } else {
    showChapter(0);
  }

  function updateQuizButton(chapterId) {
    if (userScores[chapterId] !== undefined) {
      quizButtonContainer.innerHTML = `
        <button class="btn btn-secondary btn-lg shadow-sm px-4" disabled>
          Quiz already completed (Score: ${userScores[chapterId]}/3)
        </button>
      `;
    } else {
      quizButtonContainer.innerHTML = `
        <button id="generate-quiz" class="btn btn-primary btn-lg shadow-sm px-4">
          <i class="bi bi-lightbulb me-2"></i> Generate Quiz
        </button>
      `;
      document.getElementById('generate-quiz').addEventListener('click', generateQuiz);
    }
  }

  function generateQuiz() {
    const activeButton = buttons[currentIndex];
    const chapterId = activeButton.dataset.id;
    if (!chapterId) return alert("Chapter ID not found!");

    quizContent.innerHTML = `
      <div class="text-center text-muted">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Generating quiz...</p>
      </div>
    `;

    const quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
    quizModal.show();

    fetch(`/courses/quiz/${chapterId}/`)
      .then(res => res.json())
      .then(data => {
        const quiz = data.quiz;
        let html = "";
        quiz.forEach((q, idx) => {
          html += `<div class="mb-4">
            <h5 class="fw-bold">${idx + 1}. ${q.question}</h5>
            ${q.options.map((opt, i) => `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="question-${idx}" id="q${idx}-opt-${i}" value="${String.fromCharCode(65+i)}">
                <label class="form-check-label" for="q${idx}-opt-${i}">${opt.label}</label>
              </div>
            `).join('')}
          </div>`;
        });
        html += `<div id="quiz-score" class="mt-3 text-center fw-bold fs-4"></div>`;
        quizContent.innerHTML = html;

        quizForm.onsubmit = function(e) {
          e.preventDefault();
          let score = 0;
          quiz.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="question-${idx}"]:checked`);
            if (selected && selected.value.toUpperCase() === q.answer.toUpperCase()) score++;
          });
          fetch(`/courses/quiz/score/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({chapter_id: chapterId, score: score})
          }).then(res => {
            if(res.ok) {
              userScores[chapterId] = score;
              updateQuizButton(chapterId);
              const quizModalEl = document.getElementById('quizModal');
              bootstrap.Modal.getInstance(quizModalEl).hide();
            }
          });
          document.getElementById('quiz-score').innerHTML = `You got ${score} out of ${quiz.length} correct!`;
        }
      }).catch(err => {
        console.error(err);
        quizContent.innerHTML = `<p class="text-danger">Failed to generate quiz. Please try again.</p>`;
      });
  }

  // =========================
  // Résumé du cours complet
  // =========================
  const summaryBtn = document.getElementById('generate-summary');
  const summaryModalEl = document.getElementById('summaryModal');
  const summaryContent = document.getElementById('summary-content');
  const downloadBtn = document.getElementById('download-summary-pdf');

  summaryBtn.addEventListener('click', () => {
    summaryContent.innerHTML = `<div class="text-center text-muted">
      <div class="spinner-border text-warning" role="status"></div>
      <p class="mt-3">Generating course summary...</p>
    </div>`;
    const summaryModal = new bootstrap.Modal(summaryModalEl);
    summaryModal.show();

    fetch(`/courses/summarize/{{ course.id }}/`)
      .then(res => res.json())
      .then(data => {
        if(data.summary) {
          // Retours à la ligne et scroll pour résumé long
          const formattedSummary = data.summary.replace(/\n/g, '<br>');
          summaryContent.innerHTML = `<div style="max-height:400px; overflow-y:auto; white-space:pre-wrap;">${formattedSummary}</div>`;
          downloadBtn.href = `/courses/summarize/pdf/{{ course.id }}/`;
        } else {
          summaryContent.innerHTML = `<p class="text-danger">Failed to generate summary. Please try again.</p>`;
        }
      }).catch(err => {
        console.error(err);
        summaryContent.innerHTML = `<p class="text-danger">Error occurred. Please try again.</p>`;
      });
  });
});
</script>

{% endblock %}
